name: Deploy Airbyte

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select the environment to deploy (staging or production)'
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Helm repositories
        run: helm repo add airbyte https://airbytehq.github.io/helm-charts && helm repo update

      - name: Configure kubeconfig for EKS
        run: |
          ENV="${{ github.event.inputs.environment }}"
          if [ "$ENV" == "production" ]; then
            CLUSTER_NAME="mycluster-prd-eks"
          else
            CLUSTER_NAME="mycluster-stg-eks"
          fi

          aws eks update-kubeconfig --region us-east-1 --name $CLUSTER_NAME
      
      - name: Create namespace
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "üì¶ Creating namespace 'airbyte' for $ENV"
          kubectl create namespace airbyte || true    

      - name: Apply ServiceAccount
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "Applying Serviceaccount for $ENV"
          kubectl apply -f ./cicd/environments/$ENV/k8s/service-account.yaml

      - name: Apply gp3 StorageClass
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "üì¶ Applying gp3 StorageClass for $ENV"
          kubectl apply -f ./cicd/environments/$ENV/k8s/gp3-storageclass.yaml

      - name: Deploy Airbyte with Helm
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "üöÄ Deploying Airbyte to $ENV environment"
          helm upgrade --install airbyte airbyte/airbyte \
            --namespace airbyte \
            --create-namespace \
            --values ./cicd/environments/$ENV/values.yaml
      
      # üß† Cria o Secret com o arquivo htpasswd (Base64 vindo do GitHub Secrets)
      - name: Apply Basic Auth Secret
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "üîê Applying NGINX Basic Auth Secret for $ENV"
          envsubst < ./cicd/environments/$ENV/k8s/nginx-basic-auth-secret.yaml | kubectl apply -f -
        env:
          BASIC_AUTH_FILE_BASE64: ${{ secrets.BASIC_AUTH_FILE_BASE64 }}

      # üöÄ Faz o deploy do NGINX proxy que protege o Airbyte
      - name: Deploy NGINX Auth Proxy
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "üöÄ Deploying NGINX Auth Proxy to $ENV environment"
          kubectl apply -f ./cicd/environments/$ENV/k8s/nginx-basic-auth.yaml

      # üåê Aplica o Ingress (mant√©m o ALB, mas agora aponta pro proxy)
      - name: Apply Ingress
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "üåê Applying Ingress for $ENV"
          kubectl apply -f ./cicd/environments/$ENV/k8s/ingress.yaml
